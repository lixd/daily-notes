# 可靠通信三原则

可靠通信必须实现以下三原则：

* 1）不丢包
* 2）不重复
* 3）完整性(原子性)

为了达到这三项要求，对应有**三条定理(可靠通信三原则)**：

* 1）**重传定理**：确认和重传是解决丢包问题的**唯一正确**方法
* 2）**去重定理**：排队是解决去重问题的**唯一正确**方案
* 3）**原子定理**：单点标记或者循环自校验是实现完整性的**唯一正确**方法。



> 有些同学可能对排队理论有怀疑, 表示搞一个全局位图(标记集合)也能解决去重问题. 如果深究, 判断标记和修改标记是独立的两步操作, 这两步操作就遇到去重问题, 也即, 对标记集合的操作本身也需要排队. 当然, CAS 是一种解决方案, 但 CAS 的实现内部本质也是排队.





TCP 为什么能实现可靠通信？

因为 TCP 至少遵循了这三条定理：

* TCP 有超时重传机制兜底(还有选择重传、快速重传等多项技术进行优化)

* TCP 的序号用于排队
* TCP 有 checksum 校验数据的完整性

Vinton Cerf 早年关于 TCP 协议的论文 - [A Protocol for Packet Network Intercommunication](https://www.cs.princeton.edu/courses/archive/fall08/cos561/papers/cerf74.pdf)



例如设计一个在线商店系统, 库存超卖问题本质就是判断库存和下订单这两步操作, **是一个去重的问题**. 

> 根据定理可知：**排队**是唯一解。

当然, 具体实现时, 有很多技术可以实现排队策略, 比如引入外部的队列组件, 利用数据库的锁(悲观锁或者乐观锁, 显式锁或者隐式锁). 方法有很多, 但本质只对应一条定理.

还是在线商店系统的问题, 订单和支付一般是两套独立的系统, 这就是涉及到了**不丢包的问题**. 

> 根据定理可知：**确认和重传机制**是唯一解。

所谓的分布式事务(XA), 本质也要依赖确认和重传。