# epoll的ET和LT触发模式

## 1. 概述

LT 模式即 Level Triggered 工作模式，水平触发，epoll 中的**默认工作模式**。

ET 模式即 Edge Triggered 工作模式，边沿触发。

这两个词汇来自电学术语，你可以将 fd 上有数据认为是**高电平**，没有数据认为是**低电平**，将 fd 可写认为是**高电平**，fd 不可写认为是**低电平**。那么水平模式的触发条件是状态处于高电平，而边缘模式的触发条件是新来一次电信号将当前状态变为高电平，即：

**水平模式的触发条件**

* 1）处于高电平状态

**边缘模式的触发条件**

* 1）低电平 => 高电平
* 2）高电平 => 高电平



* LT 模式下，只要处于高电平，epoll_wait 就会一直被唤醒；

* ET 模式下，只有变成高电平的时候 epoll_wait 会被唤醒一次。
  * 不管是低到高还是高到高都会触发。

> 类似于 状态驱动和事件驱动





## 2. 例子

以 socket 的读写事件为例。

### 2.1 Socket 读事件

* 对于水平模式，只要 socket 上有未读完的数据，就会一直产生 EPOLLIN 事件；

* 而对于边缘模式，socket 上每新来一次数据就会触发一次，只有再收到新数据的时候才会再触发一次。

**socket 可读事件水平模式触发条件：**

* 1）socket处于有数据（可读）状态

**socket 可读事件边缘模式触发条件：**

* 1）socket 不可读） => socket 可读
* 2）socket 又新来一次数据，即从可读状态变成可读状态（你搁这搁这呢）。



### 2.2  Socket 写事件

* 对于水平模式，只要 socket 的 TCP 窗口处于不饱和状态，就会一直触发 EPOLLOUT 事件；

* 而对于边缘模式，只有从饱和变成不饱和的时候才会触发一次。除非 TCP 窗口由不饱和变成饱和后再一次变成不饱和，才会再次触发 。

**socket 可写事件水平模式触发条件：**

* 1）socket 处于可写状态

**socket 可写事件边缘模式触发条件：**

* 1）socket 不可写 => socket 可写
* 2）socket 可写 => socket 可写



## 3. 优缺点

### 2.1 LT

优点：fd 处于可读或可写状态时，会一直触发 epoll_wait ，保证了数据的完整输出。对编程要求较低，同时也不会出现太大的问题。

缺点：有大量的 epoll_wait 被唤醒，白白消耗CPU资源，所以效率较低。

### 2.2 ET

优点：每次可读可写事件内核只会通知一次，大大减少了内核资源的浪费，提高效率。

缺点：对编程要求高，容易遗漏事件，产生bug。



## 4. 为什么ET模式下需要设置为非阻塞IO？

**为什么ET模式下需要设置为非阻塞IO？**

想象这样一个场景：
有一个pipe描述符 fd 按顺序发生了如下的动作：

* 1）读端的 fd 被注册到一个epoll的描述符当中， 监听读信号， 此时pipe中没有消息， 无论是边缘触发还是水平触发此刻都不会被触发
* 2）fd 的写端被写入2kb数据
* 3）读端调用epoll_wait， 返回 fd， 此刻pipe中有2kb数据， 并且从不可读变为可读， 所以边缘触发和水平触发都会返回
* 4）读端读取1kb的数据
* 5）读端继续调用epoll_wait

在第五步的时候， 边缘触发和水平触发的差异就显现出来了， 此时pipe中仍然有数据，所以水平触发的epoll会立刻返回， 但是边缘触发的epoll_wait 并不会返回， 因为此时并没有新的事件触发。

**所以这里就会出现一个问题**， 如果写端在等读端处理完数据返回， 而读端却在等写端的2kb数据中的另外1kb， 双方就会产生死锁。

**因此， 在使用边缘触发的时候， 建议将描述符设置为nonblocking, 并且在read/write产生EAGAIN的错误之后再使用epoll_wait**。



## 5. 小结

LT 与 ET 可以看做是**状态驱动**与**事件驱动**。

LT 效率低一些但是简单，编程要求低不易出Bug。

ET 效率低但是难，编程要求高。



## 6 .参考

`https://developer.aliyun.com/article/412825`

`https://zhuanlan.zhihu.com/p/63179839`

`https://cloud.tencent.com/developer/article/1636224`

`https://juejin.cn/post/6845166891674124302`

`https://blog.csdn.net/weixin_40204595/article/details/83213332`