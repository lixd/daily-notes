# 四层负载与七层负载

## 1. 概述

所谓

* 四层就是基于IP+端口的负载均衡；
* 七层就是基于URL等应用层信息的负载均衡；
* 二层负载均衡就是基于MAC地址的负载均衡；
* 三层负载均衡就是基于IP地址的负载均衡；

换句换说：

* 二层负载均衡会通过一个虚拟MAC地址接收请求，然后再分配到真实的MAC地址；
* 三层负载均衡会通过一个虚拟IP地址接收请求，然后再分配到真实的IP地址；
* 四层通过虚拟IP+端口接收请求，然后再分配到真实的服务器；
* 七层通过虚拟的URL或主机名接收请求，然后再分配到真实的服务器。



## 2. 区别

**所谓四层负载均衡**， 也就是主要通过报文中的**目标地址和端口**，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。

以常见的TCP为例，负载均衡设备在接收到第一个来自客户端的SYN 请求时，即通过上述方式选择一个最佳的服务器，并对报文中目标IP地址进行修改(改为后端服务器IP），直接转发给该服务器。TCP的连接建立，即三次握手是客户端和服务器直接建立的，负载均衡设备只是起到一个**类似路由器的转发动作**。在某些部署情况下，为保证服务器回包可以正确返回给负载均衡设备，在转发报文的同时可能还会对报文原来的源地址进行修改。

**所谓七层负载均衡**，也称为“内容交换”，也就是主要通过报文中的真正有意义的应用层内容，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。

以常见的TCP为例，**负载均衡设备如果要根据真正的应用层内容再选择服务器，只能先代理最终的服务器和客户端建立连接(三次握手)后，才可能接受到客户端发送的真正应用层内容的报文，然后再根据该报文中的特定字段，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器**。负载均衡设备在这种情况下，更类似于一个**代理服务器**。负载均衡和前端的客户端以及后端的服务器会分别建立TCP连接。所以从这个技术原理上来看，七层负载均衡明显的对负载均衡设备的要求更高，处理七层的能力也必然会低于四层模式的部署方式。



## 3. 小结

四层负载均衡类似路由器，直接将报文转发到后端服务器，即客户端直接和后端服务器建立连接。

七层负载均衡则是代理服务器，客户端和 七层负载均衡设备建立连接，七层负载均衡设备和后端服务器建立连接。

> 所谓连接其实就是通信双方在内存中维护的一段数据。