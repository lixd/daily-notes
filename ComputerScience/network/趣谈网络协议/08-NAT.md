# NAT & NAPT

## 1. 概述

同一个网段只需要有 MAC 地址就可以进行通信。

跨网段则需要先发给网关进行路由才能通信。

> 网关往往是一个路由器，是一个三层转发的设备。
>
> 准确的说网关其实是路由器上的一个网口。



网关有两种类型：

* 不改变 IP 地址的网关，我们称为 **转发网关**；

* 改变 IP 地址的网关，我们称为**NAT 网关**。

Network Address Translation，简称 NAT。





## 2. NAT

 地址转换的基本原理是在转发网络包时对 IP 头部中的 IP 地址进行改写。

假设我们的电脑内网 IP 是 192.168.1.3，在访问公网时，由于不在一个网段所以会经过网关，网关则会进行一次 SNAT 把IP头中的`srcIP:192.168.1.3`改成公网地址，比如`srcIP:183.69.231.120`,这样对服务器来说就是 183.69.231.120 这个 IP 在访问他。

然后服务器的响应包IP头就是这样的：`dstIP:183.69.231.120` ，网关收到后又会进行一次 DNAT，将其转成成我们的内网IP,`dstIP:192.168.1.3`。



早期 NAT 是比较简单的，但是需要私有地址和共有地址一一对应。



## 3. NAPT

Network Address Port Transfer 网络地址端口转换，也叫PAT。

**一个全局IP+不同的端口号对应多个私有IP（即多台计算机）**，需要一个全局IP对应多台计算时，比如局域网内部计算机访问外界网络时，就得用NAPT。**一对多**，多个内部地址使用同一地址不同端口转换成外部地址进行通信。缺点在于其通信仅限于**TCP或UDP**。

> 因为需要知道端口号才行。



具体过程如下：

私有网主机192.168.1.2要访问公共网中的 Http服务器166.111.80.200。首先，要建立TCP连接，假设分配的TCP Port是1010，发送了1个IP包（Des=166.111.80.200:80,Src=192.168.1.2:1010）,当IP包经过NAT 网关时，NAT会将IP包的源IP转换为NAT的公共IP，同时将源Port转换为NAT动态分配的1个Port。然后，转发到公共网，此时IP包 （Des=166.111.80.200：80，Src=202.204.65.2:2010）已经不含任何私有网IP和Port的信息。

由于IP包的源 IP和Port已经被转换成NAT的公共IP和Port，响应的IP包 （Des=202.204.65.2:,Src=2010166.111.80.200:80）将被发送到NAT。

这时NAT会将IP包的目的IP转换成私有网主机的IP，同时将目的Port转换为私有网主机的Port，然后将IP包 （Des=192.168.1.2:1010，Src=166.111.80.200:80）转发到私网。对于通信双方而言，这种IP地址和Port的转换是完全透明的。
