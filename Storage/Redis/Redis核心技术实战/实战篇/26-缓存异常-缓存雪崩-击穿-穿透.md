# 如何解决缓存雪崩、击穿、穿透难题？

## 1. 概述

除了数据不一致问题，我们常常还会面临缓存异常的三个问题，分别是缓存雪崩、缓存击穿和缓存穿透。下文会分析这三个问题并给出对应的解决方案。



## 2. 缓存雪崩

缓存雪崩是指大量的应用请求无法在 Redis 缓存中进行处理，紧接着，应用将大量请求发送到数据库层，导致数据库层的压力激增。

> 即缓存 miss 导致所有压力都打到了数据库。

缓存雪崩一般是由两个原因导致的：

* 缓存中有大量数据同时过期，导致大量请求无法得到处理；
* Redis 实例宕机。



### 原因一：大量key同时过期

**原因一：缓存中有大量数据同时过期，导致大量请求无法得到处理。**

具体来说，当数据保存在缓存中，并且设置了过期时间时，如果在某一个时刻，大量数据同时过期，此时，应用再访问这些数据的话，就会发生缓存缺失。紧接着，应用就会把请求发送给数据库，从数据库中读取数据。

> 如果应用的并发请求量很大，那么数据库的压力也就很大，这会进一步影响到数据库的其他正常业务请求处理。

针对大量数据同时失效带来的缓存雪崩问题，我给你提供两种解决方案。

**首先，我们可以避免给大量的数据设置相同的过期时间。在设置过期时间时，给过期时间增加一个随机数（例如，随机增加 1~3 分钟）**，这样一来，不同数据的过期时间有所差别，但差别又不会太大，既避免了大量数据同时过期，同时也保证了这些数据基本在相近的时间失效，仍然能满足业务需求。

**其次，我们还可以通过服务降级，来应对缓存雪崩。**

* 当业务应用访问的是非核心数据（例如电商商品属性）时，暂时停止从缓存中查询这些数据，而是直接返回预定义信息、空值或是错误信息；
* 当业务应用访问的是核心数据（例如电商商品库存）时，仍然允许查询缓存，如果缓存缺失，也可以继续通过数据库读取。



### 原因二：Redis实例宕机

**原因二，Redis 实例宕机**。Redis 缓存实例发生故障宕机了，无法处理请求，这就会导致大量请求一下子积压到数据库层，从而发生缓存雪崩。

> 一般来说，一个 Redis 实例可以支持数万级别的请求处理吞吐量，而单个数据库可能只能支持数千级别的请求处理吞吐量，它们两个的处理能力可能相差了近十倍。由于缓存雪崩，Redis 缓存失效，所以，数据库就可能要承受近十倍的请求压力，从而因为压力过大而崩溃。



**第一个建议，是在业务系统中实现服务熔断或请求限流机制。**

所谓的服务熔断，是指在发生缓存雪崩时，为了防止引发连锁的数据库雪崩，甚至是整个系统的崩溃，我们暂停业务应用对缓存系统的接口访问

请求限流，就是指，我们在业务系统的请求入口前端控制每秒进入系统的请求数，避免过多的请求被发送到数据库。

**第二个建议就是事前预防。**

**通过主从节点的方式构建 Redis 缓存高可靠集群。**如果 Redis 缓存的主节点故障宕机了，从节点还可以切换成为主节点，继续提供缓存服务，避免了由于缓存实例宕机而导致的缓存雪崩问题。



## 3. 缓存击穿

缓存击穿是指，针对某个访问非常频繁的热点数据的请求，无法在缓存中进行处理，紧接着，访问该数据的大量请求，一下子都发送到了后端数据库，导致了数据库压力激增，会影响数据库处理其他请求。

> 缓存击穿的情况，经常发生在热点数据过期失效时，和缓存雪崩相比，缓存击穿失效的数据数量要小很多。

解决方案：**对于访问特别频繁的热点数据，我们可以不设置过期时间**。这样一来，对热点数据的访问请求，都可以在缓存中进行处理，而 Redis 数万级别的高吞吐量可以很好地应对大量的并发请求访问。



## 4. 缓存穿透

**缓存穿透是指要访问的数据既不在 Redis 缓存中，也不在数据库中，导致请求在访问缓存时，发生缓存缺失**，再去访问数据库时，发现数据库中也没有要访问的数据。此时，应用也无法从数据库中读取数据再写入缓存，来服务后续请求，导致每次请求都会走到数据库层。

发生缓存穿透一般有两种情况。

* 业务层误操作：缓存中的数据和数据库中的数据被误删除了，所以缓存和数据库中都没有数据；
* 恶意攻击：专门访问数据库中没有的数据。



**第一种方案是，缓存空值或缺省值。**

一旦发生缓存穿透，我们就可以针对查询的数据，在 Redis 中缓存一个空值或是和业务层协商确定的缺省值（例如，库存的缺省值可以设为 0）。

> 数据库中都查不到的时候，直接在缓存中写入空值，防止缓存穿透。

**第二种方案是，使用布隆过滤器快速判断数据是否存在，避免从数据库中查询数据是否存在，减轻数据库压力。**

正是基于布隆过滤器的快速检测特性，我们可以在把数据写入数据库时，使用布隆过滤器做个标记。当缓存缺失后，应用查询数据库时，可以**通过查询布隆过滤器快速判断数据是否存在**。如果不存在，就不用再去数据库中查询了。

**最后一种方案是，在请求入口的前端进行请求检测。**在请求入口前端，对业务系统接收到的请求进行合法性检测，把恶意的请求（例如请求参数不合理、请求参数是非法值、请求字段不存在）直接过滤掉。



## 5. 小结

| 问题     | 原因                                                         | 应对方案                                                     |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 缓存雪崩 | 大量数据同时过期<br/>Reids 实例宕机                          | 给缓存数据的过期时间上加上小的随机数，避免同时过期<br/>服务降级<br/>服务熔断<br/>请求限流<br/>Redis缓存主从集群保证高可用 |
| 缓存击穿 | 访问非常频繁的热点数据过期                                   | 不给热点数据设置过期时间，一直保留                           |
| 缓存穿透 | 访问数据库中都不存在的数据，导致一直缓存 miss，每次都去查询数据库 | 穿透时缓存空值或缺省值<br/>使用布隆过滤器快速判断数据是否存在<br/>在请求入口前端对请求合法性进行检查 |



服务熔断、服务降级、请求限流这些方法都是属于“有损”方案，在保证数据库和整体系统稳定的同时，会对业务应用带来负面影响。

所以，尽量使用预防式方案：

* 针对**缓存雪崩**，合理地设置数据过期时间，以及搭建高可靠缓存集群；
* 针对**缓存击穿**，在缓存访问非常频繁的热点数据时，不要设置过期时间
* 针对**缓存穿透**，提前在入口前端实现恶意请求检测，或者规范数据库的数据删除操作，避免误删除。