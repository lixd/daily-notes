# Redis的下一步：基于NVM内存的实践

## 1. 概述

NVM（Non-Volatile Memory）即新型非易失存储。NVM 器件具有容量大、性能快、能持久化保存数据的特性，这些刚好就是 Redis 追求的目标。

同时，NVM 器件像 DRAM 一样，可以让软件以字节粒度进行寻址访问，所以，在实际应用中，NVM 可以作为内存来使用，我们称为 NVM 内存。



## 2. NVM 内存的特性与使用模式

首先，NVM 内存最大的优势是可以直接持久化保存数据；

> 数据保存在 NVM 内存上后，即使发生了宕机或是掉电，数据仍然存在 NVM 内存上

其次，NVM 内存的访问速度接近 DRAM 的速度;

> 它的读延迟大约是 200~300ns，而写延迟大约是 100ns。在读写带宽方面，单根 NVM 内存条的写带宽大约是 1~2GB/s，而读带宽约是 5~6GB/s

最后，NVM 内存的容量很大;这是因为，NVM 器件的密度大，单个 NVM 的存储单元可以保存更多数据。

> 例如，单根 NVM 内存条就能达到 128GB 的容量，最大可以达到 512GB，

### AEP 内存

现在，业界已经有了实际的 NVM 内存产品，就是 Intel 在 2019 年 4 月份时推出的 Optane AEP 内存条（简称 AEP 内存）。

AEP 内存给软件提供了两种使用模式，分别对应着使用了 NVM 的容量大和持久化保存数据两个特性。

第一种是 Memory 模式。

这种模式是把 NVM 内存作为大容量内存来使用的，也就是说，只使用 NVM 容量大和性能高的特性，没有启用数据持久化的功能。

> 例如，我们可以在一台服务器上安装 6 根 NVM 内存条，每根 512GB，这样我们就可以在单台服务器上获得 3TB 的内存容量了。

在 Memory 模式下，服务器上仍然需要配置 DRAM 内存，但是，**DRAM 内存是被 CPU 用作 AEP 内存的缓存**，DRAM 的空间对应用软件不可见。换句话说，软件系统能使用到的内存空间，就是 AEP 内存条的空间容量。



第二种是 App Direct 模式。

这种模式启用了 NVM 持久化数据的功能。在这种模式下，应用软件把数据写到 AEP 内存上时，数据就直接持久化保存下来了。所以，使用了 App Direct 模式的 AEP 内存，也叫做持久化内存（Persistent Memory，PM）。



## 3. 基于 NVM 内存的 Redis 实践

当 AEP 内存使用 Memory 模式时，应用软件就可以利用它的大容量特性来保存大量数据，Redis 也就可以给上层业务应用提供大容量的实例了。而且，在 Memory 模式下，Redis 可以像在 DRAM 内存上运行一样，直接在 AEP 内存上运行，不用修改代码。

> NVM 的读延迟大约是 200~300ns，而写延迟大约是 100ns，比 DRAM 略高一点，所以整体 Redis 读性能会有所降低，们就需要在保存大量数据和读性能较慢两者之间做个取舍。



为了保证数据可靠性，Redis 设计了 RDB 和 AOF 两种机制，把数据持久化保存到硬盘上。

我们先简单小结下现在 Redis 在涉及持久化操作时的问题：

* RDB 文件创建时的 fork 操作会阻塞主线程；
* AOF 文件记录日志时，需要在数据可靠性和写性能之间取得平衡；
* 使用 RDB 或 AOF 恢复数据时，恢复效率受 RDB 和 AOF 大小的限制。

当我们使用 App Direct 模式，把 AEP 内存用作 PM 时，就可以充分利用 PM 快速持久化的特点，来避免 RDB 和 AOF 的操作。



### PM 使用方法

当服务器中部署了 PM 后，我们可以在操作系统的 /dev 目录下看到一个 PM 设备，如下所示：

```sh
/dev/pmem0
```

然后，我们需要使用 ext4-dax 文件系统来格式化这个设备：

```sh
mkfs.ext4 /dev/pmem0
```

接着，我们把这个格式化好的设备，挂载到服务器上的一个目录下：

```sh
mount -o dax /dev/pmem0  /mnt/pmem0
```

此时，我们就可以在这个目录下创建文件了。创建好了以后，再把这些文件通过内存映射（mmap）的方式映射到 Redis 的进程空间。

当然，因为 PM 的读写速度比 DRAM 慢，所以，**如果使用 PM 来运行 Redis，需要评估下 PM 提供的访问延迟和访问带宽，是否能满足业务层的需求**。

假设业务层需要支持 1 百万 QPS，平均每个请求的大小是 2KB，那么，就需要机器能支持 2GB/s 的带宽（1 百万请求操作每秒 * 2KB 每请求 = 2GB/s）。如果这些请求正好是写操作的话，那么，单根 PM 的写带宽可能不太够用了。



## 4. 小结

NVM 的三大特点：性能高、容量大、数据可以持久化保存。软件系统可以像访问传统 DRAM 内存一样，访问 NVM 内存。目前，Intel 已经推出了 NVM 内存产品 Optane AEP。

这款 NVM 内存产品给软件提供了两种使用模式，分别是 Memory 模式和 App Direct 模式。在 Memory 模式时，Redis 可以利用 NVM 容量大的特点，实现大容量实例，保存更多数据。在使用 App Direct 模式时，Redis 可以直接在持久化内存上进行数据读写，在这种情况下，Redis 不用再使用 RDB 或 AOF 文件了，数据在机器掉电后也不会丢失。而且，实例可以直接使用持久化内存上的数据进行恢复，恢复速度特别快。