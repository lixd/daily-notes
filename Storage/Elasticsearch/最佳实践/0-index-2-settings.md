# Index settings

Elasticsearch 创建 Index 需要配置 settings、mapping 这两部分。

本文主要记录如何配置 settings 部分，具体取值的参考建议。

settings 部分设置主要包括以下两方面：

* 1）分片数
* 2）分词器



## 1. 分片

### 分类

分片又可分为 Primary Shard 和 Replica Shard。

**主分片（Primary Shard）**，用以解决数据水平扩展的问题。通过主分片，可以将数据分布到集群内的所有节点之上。

* 一个分片是一个运行的 Lucene 的实例
* 主分片数在索引创建时指定，后续不允许修改，除非 Reindex

> 每个 Index 的主分片数默认最大值为 1024，可以通过 export ES_JAVA_OPTS="-Des.index.max_number_of_shards=xxx" 来修改

**副本（Replica Shard）**用以解决数据高可用的问题，是主分片的拷贝，保证节点故障时数据不丢失。

* 副本分片数可以动态地调整
* 增加副本数，还可以在一定程度上提高服务的可用性（读取的吞吐）

**分片配置**

对于生产环境中分片的设定，需要提前做好容量规划，7.0 开始默认主分片设置成1 ，解决了 over-sharding 的问题。

* 分片数设置过小
  * 导致后续无法增加节点实现水平扩展
  * 当个分片的数据量太大，导致数据重新分配耗时
* 分片数设置过大
  * 影响搜索结果的相关性打分，影响统计结果的准确性
  * 单个节点上过多的分片，会导致资源浪费，同时也会影响性能



> 分片数设置太小则存在扩展问题，设置太大又会影响性能。需要根据大致的数据量合理设置该值。

```http
PUT my-index-000001
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1,
  }
}
```



### 设置建议

分片数量越多，维护这些索引的开销就越大。

分片大小越大，当 Elasticsearch 需要重新平衡集群时，移动分片所需的时间就越长。

设置建议：

* 1）将平均分片大小保持在几 GB 到几十 GB 之间。
  * 例如日志数据，一般分片大小为 20~40GB。
  * 根据预测数据量即可计算出需要的主分片数。
* 2）避免出现大量分片。
  * 一个节点可以容纳的分片数量与可用的堆空间成正比。每 GB 堆内存对应的的分片数应小于 20。



**例子**

**主分片**：建议的分片大小为 20G，预测数据会有 100G，那么至少需要 100/20 = 5 个主分片，分片时可以多留一点余量，比如分片 6、7个都行。



**副本**：最少需要 1 个。如果空间充足可以设置成和集群中的节点数一致。这样只要有一个节点在数据都不会丢失。同时还要根据机器配置决定，需要保证 保证节点上不要出现大量分片。按照每GB heap 空间对应 10 个分片来算，8G 堆空间可以分片 80 个分片。假如集群中有80 index，则刚好每个节点 80 个分片(主分片或者副本)。如果 index 为160则每个节点分片数超过推荐值了，此时就需要增加内存、增加节点或者减少副本数。



## 2. 分词器

创建 Index 时可以分别指定默认的 Index Analyzer 和 Search  Analyzer。

* analyzer.default 指定 Index 和 Search 时的默认 Analyzer。
* analyzer.default_search 则单独指定搜索时的默认 Analyzer，若不指定则搜索时也会使用 analyzer.default 所指定的 Analyzer。

> 此处设置的是 default analyzer，index 或 search 时也可以单独指定要使用的 analyzer。

```http
PUT my-index-000001
{
  "settings": {
    "analysis": {
      "analyzer": {
        "default": {
          "type": "ik_max_word"
        },
         "default_search": {
          "type": "ik_mark"
        }
      }
    }
  }
}
```



### 设置建议

**Index 时按照最细粒度分词，以便 Search 时能匹配到更多的文档。而 Search 时则按最粗粒度分词，以提升精确度。**

> 例如写入 华为手机 时，分词为 华为、手机、华为手机这三部分写入。
>
> 用户搜索 华为手机 时就按照最粗粒度拆分，即分词后还是华为手机，此时搜索只会返回华为手机，其他的华为xxxx或者xxx手机就不会被搜索到。