# 自建邮件服务器

## 1. 概述

本文主要目的为：**自建一个邮件服务器用于向 QQ、163、Gmail 等邮局进行邮件群发以实现营销功能**。

由于各大邮局都有自己的反垃圾邮件算法，直接暴力群发肯定是会被各大邮局**拒收+拉黑**，各大邮局限制如下：

* Gmail：每小时发送量限制 50 封，每天发送量最多500封。
* QQ：普通用户：每天最大发信量是100封
* 163：一封邮件最多发送给 40 个收件人 , 每天发送限额为 50 封。
* sina：新浪企业邮箱试用期用户每天限制 80 封，购买后发信没有限制。新浪免费邮箱，每天限制发送 30 封 。

> 数据来源[网络](https://www.freehao123.com/mail-smtp/)。



所以本文将分为两个部分进行：

* 1）搭建邮件服务器
* 2）提升邮件信誉度

第一部分 搭建邮件服务器 比较简单，主要是第二部分 提升邮件信誉度 复杂一些，大致分为以下几个方面进行：

* 1）域名解析设置
* 2）邮件内容优化
* 3）IP 预热



## 2. 名词解释

### 1. 相关协议

**SMTP**：全称为 Simple Mail Transfer Protocol，简单邮件传输协议。它定义了邮件客户端软件和SMTP邮件服务器之间，以及两台SMTP邮件服务器之间的通信规则。

**POP3**：全称为 Post Office Protocol，邮局协议。它定义了邮件客户端软件和POP3邮件服务器的通信规则。

**IMAP**：全称为 Internet Message Access Protocol,Internet消息访问协议，它是对POP3协议的一种扩展，也是定义了邮件客户端软件和IMAP邮件服务器的通信规则。

小结：**SMTP 负责邮件传递，POP3 / IMAP 负责邮件存取。**

**POP3 和 IMAP 区别？**

POP3 是比较老的协议，而 IMAP稍 微新一点(距离现在也很久了…)。 他们之间的区别摘录 163 邮箱帮助文档中的一段说明：

* POP3协议允许电子邮件客户端下载服务器上的邮件，但是在客户端的操作（如移动邮件、标记已读等），不会反馈到服务器上，比如通过客户端收取了邮箱中的3封邮件并移动到其他文件夹，邮箱服务器上的这些邮件是没有同时被移动的 。

* IMAP提供webmail 与电子邮件客户端之间的双向通信，客户端的操作都会反馈到服务器上，对邮件进行的操作，服务器上的邮件也会做相应的动作。

> 我们只需要搭建邮件服务器，不需要关注客户端软件，所以只需要关注 SMTP 即可。



### 2. 相关角色

**ESP**：Email Service Provider，邮局服务商，一般指各大邮件平台，如 QQ、163、Gmail 等。

**MUA**：Mail User Agent，邮件用户代理。用来收信和发信的，比如我们熟悉的Outlook，Foxmail等。

**MTA**：Mail Transfer Agent，邮件传输代理代为传递，Sendmail和Postfix就是扮演MTA的角色。

**MDA**：Mail Delivery Agent，邮件投递代理，分析由 MTA 所收到的信件表头或内容等数据， 来决定这封邮件的去向。

**MRA**：Mail Retrieval Agent，主要使用 POP3 协议来收取自己的信件。

**所以一封邮件的流程是**：

发件人-->MUA --发送--> MTA -> 若干个MTA... -> MTA -> MDA <--收取-- MUA<--收件人

```sh
             │░░░░░░░░░│    │░░░░░░░░░│    │░░░░░░░░░│
┌───────┐    ├─────────┤    ├─────────┤    ├─────────┤    ┌───────┐
│░░░░░░░│    │░░░░░░░░░│    │░░░░░░░░░│    │░░░░░░░░░│    │░░░░░░░│
├───────┤    ├─────────┤    ├─────────┤    ├─────────┤    ├───────┤
│       │───>│O ░░░░░░░│───>│O ░░░░░░░│───>│O ░░░░░░░│<───│       │
└───────┘    └─────────┘    └─────────┘    └─────────┘    └───────┘
   MUA           MTA            MTA            MDA           MUA
```



MTA和MDA这样的服务器软件通常是现成的，我们不关心这些服务器内部是如何运行的。要发送邮件，我们关心的是如何编写一个MUA的软件，把邮件发送到MTA上。

**MUA 到 MTA 发送邮件的协议就是 SMTP 协议，它是 Simple Mail Transport Protocol 的缩写，使用标准端口 25，也可以使用加密端口 465 或587。**



### 3. 发送方式

常见邮件发送有两种方式，自建邮与租用邮。

* **租用邮**：比如租用 QQ 邮箱，可以直接通过 QQ 邮箱客户端(MUA)发送给 QQ 邮件服务器(MTA)，再转发到邮件对应的邮局。
* **自建邮**：自建 MTA 服务器，直接发送到对应邮局服务器。

租用邮一般是流行的邮件系统，他们拥有高质量、高信誉度的 IP 池，通过他们的 MTA 服务器发送出去的邮件一般不会被拦截。

自建邮则需要想办法提升自己的 MTA 服务器的信誉度，否则很容易被拦截。

所以接下来进入第二部分：提升邮件信誉度



## 3. 邮件信誉度

### 1. IP 地址

**IP 地址是和信誉度相关性最重要的一环**，因为邮件是由发送服务器的 IP 地址发出的，也就是发送邮件的通道。

IP 地址是分类型的：

* 1）完全固定IP (托管主机的 IP，可以反解析)，这种信誉度最高
* 2）VPS (云主机)上的固定 IP，一些国外的 ESP 给这样的 IP 信誉度比较低，比如 hotmail、yahoo,他们收到这样 IP 发过来的邮件，比较容易放到垃圾箱。
* 3）动态 IP，比如我们家庭用的拨号网络获取的 IP，ESP 是可以知道这种 IP 类型的，有很多 ESP 都拒收这种类型 IP 发过来的邮件，比如 sina,yahoo。

IP 的信誉度是针对某个具体 ESP 的，比如有些 IP 发 QQ邮件效果很好，但是发国外邮件效果很差，因为不同的 ESP 判定标准不同。

IP 的信誉度是慢慢建立起来的，用行内的话说叫做预热 IP，一个新 IP 初始的时候可能每天只能发送几百封邮件，随着你发送高质量的邮件越来越多，ESP 分配给 IP 的可发信量也就会越来越大，直到一个 IP 可以到每日几十万封。

不同的 ESP 的预热过程不同，有的比较严格，我们先假设您发送的邮件质量本身很好，讲一下**常见邮局的预热过程**：

* 1）比如 QQ 邮局，新 IP 第一天可能只能发送 100 封左右，然后第二天发 200 封，第三天 400 封，第四天 800 封，一般一周以内就可以上千了，一个月以内肯定可以上万了，通常一个预热好的 IP 每日可以发几万以上。
* 2）还有一些邮局比较宽松，比如 163 邮局，第一天发 400 封就没问题，第二天 800 封，第三天就可以 1500 封，一般一周以内就可以每日 2000-3000 封左右了，两周就可以上万了。
* 3） 其他邮局一般也不是像 QQ 那么严格，需要逐步去试，**一般当天持续进垃圾箱那就代表要停止了**，或者可以换内容再试一下，还是进垃圾箱，那就第二天再发。



### 2. 域名

**除了 IP 以外，域名是第二重要的因素**，甚至如果你的域名信誉度很高，就算 IP 质量不算太好，也能大量发送到收件箱。

* 1）发信邮箱域名可以是顶级域名也可以是二级域名，一般企业推荐用二级域名，这样可以对主域名起到的一定的保护作用。
* 2）发信邮箱域名的 A 记录或者 CNAME 记录最好指向一个实际网站，这样可以提高域名的信誉度。
* 3）发信邮箱域名的 MX 记录最好要指向某个实际收邮件的服务器地址，企业邮箱的地址也可以。
* 4）发信邮箱所在邮局，最好有 PostMaster 邮箱，因为有些 ESP 会给这个邮箱投送消息，如果存在这个邮箱，也会增加信用度。
* 5）**发信邮箱的域名一定要设上 SPF 记录**，SPF（（Sender Policy Framework） ） 记录中一定要包含你发送邮件的 IP，这样会提升很多信誉度，这是必配项。
* 6）发信邮箱的域名一定要加上 DKIM 记录，并且要对邮件进行 DKIM 加密，这样也会增加信誉度，这是必配项。
  * [MailEnable DKIM](https://www.mailenable.com/documentation/10.0/Standard/Domain_-_DKIM_(DomainKeys).html?highlight=dkim%2C)
* 7）最好把 IP 反解析到 MTA 的子域名。
  * [阿里云反向解析](https://help.aliyun.com/document_detail/155894.html?spm=5176.22414175.sslink.6.386c6ebd9AaVnF)
* 8）同样域名的信誉度也是要慢慢培养的，比如你的一个新域名配了 3 个新IP，想培养 QQ 的信誉度，那第一天的发信量就应该是 3×100，第二天的发信量就是 3×200，以此类推，IP 越多，域名培养信誉度越快。



### 3. 邮件内容

* 1）邮件内容中不能有敏感词，同时不能使用大量的变量。
* 2）邮件内容的格式要正规化，比如抬头的称呼，结尾的敬语等。
* 3）邮件中最好要加上`退订链接`，这样可以有效的避免很多投诉邮件。

注意：**千万不要用大量的发件箱去发同样的内容，这样很容易被认定是垃圾发送者**，应该是不同的发件箱发送不同类型的邮件内容。



### 4. 收件客户与 ESP 互动

这也是 ESP 评价邮件信用度非常非常重要的一环，会累积到你的信誉度中。

* 1）客户打开并浏览邮件，这会增加你的信誉度。
* 2）客户点击你邮件内的链接，这也会有效增加信誉。
* 3）客户把你这个发件人添加到通讯录，也会增加信誉。
* 4）客户给你的邮件加星和回复邮件，也会增加信誉。



### 5. 小结

**最为关键的其实是客户邮件地址**，只有你发送的内容是客户真正需要的，而且目标群体非常明确，那才会产生收邮件客户和 ESP 之间的互动，客户才会打开，才会点击链接，你的信誉度才会累计起来。



## 4. 方案汇总

根据上面的一些调查，最终有以下 3  个方案供选择：

* 1）**租用邮**：购买 QQ、163  等各大邮局账号来发送
  * 受邮件内容 + 账号限制
  * 每个账号一般每天只能发 100 封
* 2）**自建邮-动态IP**：本地 Windows 自建邮 + 拨号变更 IP
  * 受邮件内容 + IP 限制
  * 动态IP信誉度低，每个IP 每天最多能发 100 封。
* 3）**自建邮-固定IP**：Linux 服务器自建邮 + 固定 IP 养号
  * 受邮件内容 + IP 限制
  * IP 预热以提升信誉度，从而增加每日发送限制



各个方案的问题

* 方案1
  * 需要正规账号，批量注册的账号一般第一次发送就会被拉黑
* 方案2
  * 动态 IP 信誉度过低，可能直接被拉黑
  * 寻找自动拨号以变更IP的防方法 todo
* 方案3
  * 需要时间养号
  * 被举报后该 IP 就废掉了



[Linux 开源邮件服务器列表](https://www.ubuntupit.com/best-linux-mail-server-software-and-solutions/)

Linux 组件推荐：dovecot（MUA） + Postfix（MTA）

Linux 集成环境： [EwoMail](https://github.com/gyxuehu/EwoMail)，集成了dovecot（MUA） + Postfix（MTA）等组件，方便部署。

[Wlindows 开源邮件服务器](https://windowsreport.com/free-mail-server-windows-10/)

Windows 推荐：Mail Enable





## 5. 自动拨号

ASDL 自动拨号

```sh
https://blog.csdn.net/weixin_30235225/article/details/95179998
```



bat 脚本

```bat
  :start   
    @rasdial 宽带连接名称 /DISCONNECT   
    @rasdial 宽带连接名称 用户名 密码   
    @ping 0.0.0.0 -n 30 -w 1000 > nul   
    goto start  
```



## 7. 直接向 MTA 发送

之前一直是通过代码向本地 MTA 发送，再由本地 MTA 转发到远程 MTA。那么可不可以通过代码直接向远程 MTA 发送呢？
