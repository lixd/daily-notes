# CI CD

## Mono Repository

### 背景



* 基础库伴随业务的成长不断优化，频繁升级，推进困难;
* 重视代码Review,包括Coding Style和逻辑细节，但是流程不够统一，都靠自觉性，也不够自动化;
* 小bug非常多，大量的测试需要积压到发版前，返工修复bug也多，整体效率差;
* 版本管理复杂、代码复用率低、等等;



于是构建了一个 `Mono Repository`，即 将所有代码存放在一个`超级大仓库`。



### 优势

* 一致的版本，one source of truth
  * 基础库的升级:版本通通是透明可见，版本一致，间接的我们代码始终保持先进。
* 极致的代码共享，复用
  * **如果一个团队想要依赖另一个团队的代码，可以直接依赖**，Kratos代码库包含大量有用的库，而单一代码库可以引导广泛的代码共享和重用，作为-个新入职的同学简单Gitlab.上点几下就能看到整个B站的基础库和业务代码。
* 简单的依赖管理
    * 构建系统可以轻松地在目录之间包含代码，从而简化依赖关系管理，由于所有代码都在相同的仓库中进行版本控制，所以只有一个版本，也不关心依赖关系的独立版本。
    * 在大多数情况下，可能很难在不导致破坏的情况下发布新版本，因为所有调用方必须同时更新，当库调用者托管在不同的存储库中时，这种更新很困难。
    * 在开源世界中，依赖关系通常被库更新所破坏，查找所有共同工作的依赖库版本都是-个挑战。更新依赖关系的版本对于开发人员来说可能是痛苦的，延迟更新可能会变成非常昂贵的技术债务。



### 工具链的长期投入建设

* 构建工具: bazel， bazel远程分布式缓存。

* 代码托管: Gitlab， 以及持续增大的超大代码库( Git Sparse File支持)、更长期的远程IDE。

* IDE:对bazel编译、debug的IDE支持。

* test-infra:并行编译、并行UT。



  ### CoreReview

在Kratos中只有经过review过的代码才会最终合并到master主干:

* 保证质量
  * 代码正确性、完整性;
  * 测试用例、代码规范;
  * 越早发现bug，代价越低;
  * 确保可维护性;

* 人员备份
* 知识共享&教学工具& Peer Pressure
* Ownership



## CI

gitlab

